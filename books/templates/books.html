{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">

    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <h4 class="mb-2 mb-md-0">
            <i class="bi bi-book-half"></i> Books
        </h4>
        <a href="create/" class="btn btn-success">
            <i class="bi bi-plus-circle-fill"></i> Add Book
        </a>
    </div>

    <!-- Responsive Table -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-bordered table-hover align-middle text-center mb-0 bg-white">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Category</th>
                    <th>Available</th>
                    <th style="min-width:160px">Actions</th>
                </tr>
            </thead>
            <tbody id="book-table"></tbody>
        </table>
    </div>
</div>

<!-- <script>
const API = "http://127.0.0.1:8000/api/books/";
const AUTHORS_API = "http://127.0.0.1:8000/api/authors/";
const CATEGORIES_API = "http://127.0.0.1:8000/api/categories/";
const token = localStorage.getItem("access");

if (!token) window.location.href = "/login/";

// Maps for author and category names
let authorsMap = {};
let categoriesMap = {};

// Load authors
const loadAuthors = fetch(AUTHORS_API, { headers: { Authorization: "Bearer " + token } })
    .then(res => res.json())
    .then(data => {
        data.forEach(a => authorsMap[a.id] = a.name);
    });

// Load categories
const loadCategories = fetch(CATEGORIES_API, { headers: { Authorization: "Bearer " + token } })
    .then(res => res.json())
    .then(data => {
        data.forEach(c => categoriesMap[c.id] = c.name);
    });

// Load books after authors and categories
Promise.all([loadAuthors, loadCategories])
    .then(() => fetch(API, { headers: { Authorization: "Bearer " + token } }))
    .then(res => res.json())
    .then(data => {
        let rows = "";
        if (!data.length) {
            rows = `<tr><td colspan="6" class="text-muted py-3">No books available</td></tr>`;
        } else {
            data.forEach((book, index) => {
                const authorName = authorsMap[book.author] || book.author_name || "Unknown";
                const categoryName = categoriesMap[book.category] || book.category_name || "Unknown";

                rows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="fw-bold">${book.title}</td>
                        <td>${authorName}</td>
                        <td>${categoryName}</td>
                        <td>${book.available_copies}</td>
                        <td>
                            <a href="/books/${book.id}/edit/" class="btn btn-sm btn-warning mb-1">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <button class="btn btn-sm btn-danger mb-1" onclick="deleteBook(${book.id})">
                                <i class="bi bi-trash-fill"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
        document.getElementById("book-table").innerHTML = rows;
    })
    .catch(() => alert("Failed to load books"));

// Delete book
function deleteBook(id) {
    if (!confirm("Are you sure you want to delete this book?")) return;

    fetch(`${API}${id}/`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
    })
    .then(res => {
        if (res.status === 204) location.reload();
        else alert("Delete failed");
    });
}
</script> -->

<script>
const API = "http://127.0.0.1:8000/api/books/";
const AUTHORS_API = "http://127.0.0.1:8000/api/authors/";
const CATEGORIES_API = "http://127.0.0.1:8000/api/categories/";
const token = localStorage.getItem("access");

if (!token) window.location.href = "/";

let authorsMap = {};
let categoriesMap = {};

// Load authors
const loadAuthors = fetch(AUTHORS_API, {
    headers: { Authorization: "Bearer " + token }
})
.then(res => res.json())
.then(data => {
    const items = data.results || data;
    items.forEach(a => authorsMap[a.id] = a.name);
});

// Load categories
const loadCategories = fetch(CATEGORIES_API, {
    headers: { Authorization: "Bearer " + token }
})
.then(res => res.json())
.then(data => {
    const items = data.results || data;
    items.forEach(c => categoriesMap[c.id] = c.name);
});

// Load books
function loadBooks(url = API) {
    fetch(url, { headers: { Authorization: "Bearer " + token } })
    .then(res => res.json())
    .then(data => {
        const books = data.results || data;

        let rows = "";

        if (!books.length) {
            rows = `<tr>
                        <td colspan="6" class="text-muted py-3">
                            No books available
                        </td>
                    </tr>`;
        } else {
            books.forEach((book, index) => {
                const authorName = authorsMap[book.author] || book.author_name || "Unknown";
                const categoryName = categoriesMap[book.category] || book.category_name || "Unknown";

                rows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="fw-bold">${book.title}</td>
                        <td>${authorName}</td>
                        <td>${categoryName}</td>
                        <td>${book.available_copies}</td>
                        <td>
                            <a href="/books/${book.id}/edit/"
                               class="btn btn-sm btn-warning mb-1">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <button class="btn btn-sm btn-danger mb-1"
                                    onclick="deleteBook(${book.id})">
                                <i class="bi bi-trash-fill"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        document.getElementById("book-table").innerHTML = rows;
    })
    .catch(err => {
        console.error(err);
        alert("Failed to load books");
    });
}

// Init
Promise.all([loadAuthors, loadCategories])
.then(() => loadBooks());

// Delete book
function deleteBook(id) {
    if (!confirm("Are you sure you want to delete this book?")) return;

    fetch(`${API}${id}/`, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token }
    })
    .then(res => {
        if (res.status === 204) loadBooks();
        else alert("Delete failed");
    });
}
</script>


{% endblock %}
